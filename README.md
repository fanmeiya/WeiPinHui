# 唯品会比赛-基于用户行为与商品属性的推荐算法

由于给的数据集不存在显性的评分，所以自己进行设置，不断调整

用户标签权重 = 行为类型权重 × 行为次数 × 时间衰减系数

时间衰减系数 ：λ = exp(n/15*ln(0.5))，用户的行为会随着时间的过去，历史行为和当前的相关性不断减弱；越接近当前的行为，对当下的影响越强，衰减系数越高；以半衰期公式计算出来的时间衰减系数，半衰期为15天的时间衰减系数来统计30天的数据.

点击商品：1分
收藏商品：2分
加购商品：2.5分
购买商品：3.5分

**尝试1**：利用机器学习的LCM模型（隐喻义模型）

原理：将user-item的评分矩阵R~ui~分解成两个小阶矩阵P、Q；其中令P为user-feature矩阵，表示用户隐含的喜好特征矩阵，Q为item-feature矩阵表示物品隐含的喜好特征，那么R1~ui~= PQ^T^，其中feature的阶数(F)由自己确定表示隐含的特征数量，p~uk~表示user的隐含特征k，q~ik~表示item的隐含特征；所以我们需要找到这两个矩阵，使得损失函数最小
$$
Cost = \sum_{u,i∈R}(R_{ui}-R1_{ui})^2=\sum_{u,i∈R}(R_{ui}-\sum_{k=1}^Fp_{uk}*q_{ik})^2
$$
 加入L2正则化后变为
$$
Cost = \sum_{u,i∈R}(R_{ui}-\sum_{k=1}^Fp_{uk}*q_{ik})^2+\lambda(\sum_Up_{uk}^2+\sum_Iq{ik}^2)
$$
对损失函数求偏导后就变为:
$$
\frac{\part Cost}{\part p_{uk}} =-2 \sum_{u,i∈R}(R_{ui}-\sum_{k=1}^Fp_{uk}*q_{ik})q_{ik}+2\lambda_1p_{uk}\\
\frac{\part Cost}{\part q_{ik}} =-2 \sum_{u,i∈R}(R_{ui}-\sum_{k=1}^Fp_{uk}*q_{ik})p_{uk}+2\lambda_2q_{ik}
$$
然后利用机器学习中的梯度下降算法,由于$\alpha$可以随便取值，所以可以把上述的偏导数的2去掉：
$$
p_{uk} = p_{uk}-\alpha\frac{\part Cost}{\part p_{uk}}\\
q_{ik} = q_{ui}-\alpha\frac{\part Cost}{\part q_{ik}}
$$
采用随机梯度下降法，则去掉外层的求和公式得到：
$$
p_{uk} = p_{uk} + \alpha[(r_{ui}-\sum_{k=1}^F{p_{uk}q_{ik}})q_{ik}-\lambda_1p_{uk}]\\
q_{ik} = q_{ik} + \alpha[(r_{ui}-\sum_{k=1}^F{p_{uk}q_{ik}})p_{uk}-\lambda_2q_{ik}]
$$
先用随机数初始化p~uk~和q~ik~两个矩阵，随机数需要和1/sqrt(F)成正比，不断迭代上述p~uk~和q~ik~即可。

**数据处理**：首先查看给的测试用户和商品是否在训练集里面，将不在训练集里面的用户和商品去除，然后将用户行为数据按照用户和商品分组，计算每个用户对每个商品的点击次数总和、收藏次数总和、加购次数总和以及购买次数的总和，然后据此计算该用户对商品的打分；其次再将用户行为数据按照用户分组，计算其购买次数总和，去除掉没有购买记录的用户；最后剩下的用户行为数据就是用来训练的数据集。

数据集处理好了之后，开始编写LCM模型类利用训练集进行训练，其中$\alpha$=0.003，$\lambda_1$=0.001,$\lambda_2$=0.001,特征阶数F = 100，迭代500次训练得到P、Q矩阵，然后根据已经处理过的测试集的用户和商品利用P、Q矩阵点乘计算它们的打分，将打分最高的前3个推荐给用户。

**结果**：由于数据量太大，每个用户都要计算对每个商品的打分，然后再进行排序，时间消耗很长很长，最后没有跑出来。

**尝试2**：利用深度学习

尝试了两种构建深度学习模型的方法，由于深度学习以前没有接触过，短时间内无法很好地学会并灵活使用，所以方法1参考了飞桨官方的电影推荐系统的设计，方法2参考了大佬的最基本的深度学习框架。

方法1：从用户的行为数据中分析得到每个用户的商品点击购买转换率，收藏购买转换率以及加购购买转换率，将连续的转换率变成离散型，去除没有购买记录的用户；然后将用户ID、各个转换率作为用户特征，将商品的ID、品类、品牌作为商品特征；用户对商品的评分和尝试1一样。

提取用户特征和商品特征作为神经网络的输入，其中：

- 用户特征包含四个属性信息，分别是用户ID、点击转换率、购买转换率和加购转换率。
- 商品特征包含三个属性信息，分别是商品ID、商品品类和商品品牌。

1. 提取用户特征。使用Embedding层将用户ID映射为向量表示，输入全连接层，并对其他三个属性也做类似的处理。然后将四个属性的特征分别全连接并相加。
2. 提取用户特征。将商品ID、商品品类和商品品牌类型映射为向量表示，输入全连接层，然后将三个属性的特征表示分别全连接并相加。
3. 得到用户和商品的向量表示后，计算二者的余弦相似度。最后，用该相似度和用户评分的均方差作为该回归模型的损失函数。

以此构建深度学习模型，构建好了之后就可以开始训练，训练完模型后，我们得到每个用户、商品对应的特征向量，接下来将这些特征向量保存到本地，这样在进行推荐时，不需要使用神经网络重新提取特征，节省时间成本。

然后读取测试集的用户ID和商品ID，通过计算用户特征和商品特征之间的相似性，并排序选取相似度最大的结果来进行推荐。

结果：最后的结果的是运行时间很长，还是跑了好久都还在运行，没有得到结果。

方法2：

参考大佬的基本深度学习框架，在他的基础上筛选一些特征，将点击转换率，收藏转换率、加购转换率作为特征加入，去除掉没有购买记录的用户数据，不断调整学习率，Embedding层初始化参数，batch_size等参数直至达到最好结果。这个框架是能得到结果的但是成绩也只有0.00073。
